<% layout("/layouts/boilerplate") %>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  initializeMapWithGeocoding("<%= listing.location %>");
</script>

<div class="row mt-3">

  <div class="col-8 offset-2">

    <h3>
      <b><%= listing.title %></b>
    </h3>

  </div>


  <div class="card listing-card col-6 offset-2">

    <img
      src="<%= listing.image.url %>"
      class="card-img-top show-img"
    >

    <div class="card-body">

      <p class="card-text">

        <b>
          <i>
            <%= listing.owner?.username || "Admin" %>
          </i>
        </b>

        <br>

        <%= listing.description %>

        <br>

        â‚¹ <%= listing.price.toLocaleString("en-IN") %>

        <br>

        <%= listing.location %>

        <br>

        <%= listing.country %>

      </p>

    </div>

  </div>


  <% if(currentUser && listing.owner && listing.owner._id.equals(currentUser._id)) { %>


  <div class="btns col-6 offset-2 mt-3">

    <a
      href="/listings/<%= listing._id %>/edit"
      class="btn edit-btn"
    >
      Edit
    </a>

    <form
      method="POST"
      action="/listings/<%= listing._id %>?_method=DELETE"
    >

      <button class="btn btn-dark">
        Delete
      </button>

    </form>

  </div>

  <% } %>



  <div class="col-8 offset-2 mt-4">

    <% if(currUser) { %>

    <hr>

    <h4>Leave a Review</h4>

    <form
      action="/listings/<%= listing.id %>/reviews"
      method="POST"
    >

      <fieldset class="starability-slot">

        <input
          type="radio"
          name="review[rating]"
          value="1"
          checked
        >

        <input type="radio" name="review[rating]" value="2">

        <input type="radio" name="review[rating]" value="3">

        <input type="radio" name="review[rating]" value="4">

        <input type="radio" name="review[rating]" value="5">

      </fieldset>


      <textarea
        name="review[comment]"
        class="form-control mt-2"
        required
      ></textarea>


      <button class="btn btn-outline-dark mt-2">

        Submit

      </button>

    </form>

    <% } %>


    <hr>

    <h4>All Reviews</h4>


    <% listing.reviews.forEach(review => { %>

    <div class="review-card">

      <h6 class="card-title">

        @<%= review.author.username %>

      </h6>


      <p
        class="starability-result"
        data-rating="<%= review.rating %>"
      ></p>


      <p>

        <%= review.comment %>

      </p>


      <form
        method="POST"
        action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
      >

        <button class="btn btn-sm btn-dark">

          Delete

        </button>

      </form>

    </div>

    <% }) %>


  </div>


  <div class="col-6 offset-2 mt-4">

    <h4>Where you'll be</h4>

    <div
      id="map-<%= listing._id %>"
      class="listing-map"
    ></div>

  </div>


</div>


<script src="/js/map.js"></script>
